const express = require('express');
const router = express.Router();
const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('./database/db.sqlite');
const { v4: uuidv4 } = require('uuid');

// Contoh endpoint create SSH
router.post('/create-ssh', (req, res) => {
  const { user_id, username, password, server, duration } = req.body;
  const id = uuidv4();
  db.run(
    'INSERT INTO accounts (id, user_id, server_id, type, username, password, expired_at) VALUES (?, ?, ?, ?, ?, ?, datetime("now", "+" || ? || " days"))',
    [id, user_id, server, 'SSH', username, password, duration],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
      } else {
        res.json({ message: 'Akun SSH berhasil dibuat', id });
      }
    }
  );
});

// Endpoint top-up
router.post('/topup', (req, res) => {
  const { user_id, method, amount } = req.body;
  const id = uuidv4();
  db.run(
    'INSERT INTO topups (id, user_id, method, amount, status) VALUES (?, ?, ?, ?, ?)',
    [id, user_id, method, amount, 'pending'],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
      } else {
        res.json({ message: 'Permintaan top up diterima', id });
      }
    }
  );
});

module.exports = router;